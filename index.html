<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Signature Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            display: block;
            padding: 1rem;
            border: 2px dashed #D1D5DB;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .file-input-label:hover {
            border-color: #3B82F6;
            background-color: #F9FAFB;
        }
        #pdf-name, #img-name {
            font-weight: 500;
            color: #3B82F6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-lg mx-4">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">PDF Signature Tool</h1>
            <p class="text-gray-500 mt-2">Add your signature to any PDF at your desired position.</p>
        </div>

        <!-- Step 1: Upload PDF -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Step 1: Upload PDF</h2>
            <label for="pdf-upload" class="file-input-label">
                <span class="text-gray-600">Click to upload a PDF file</span>
                <span id="pdf-name" class="mt-1 block"></span>
            </label>
            <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
        </div>

        <!-- Step 2: Upload Signature -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Step 2: Upload Signature Image</h2>
             <label for="img-upload" class="file-input-label">
                <span class="text-gray-600">Click to upload an image (JPG, PNG)</span>
                <span id="img-name" class="mt-1 block"></span>
            </label>
            <input type="file" id="img-upload" class="hidden" accept="image/jpeg, image/png">
            <div class="mt-4 flex items-center justify-center">
                <input type="checkbox" id="remove-bg-check" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="remove-bg-check" class="ml-2 block text-sm text-gray-700">Remove white background from signature</label>
            </div>
            <div id="preview-section" class="mt-4 hidden">
                <div class="text-sm text-gray-600 mb-2">Live preview (adjust if paper texture remains):</div>
                <canvas id="preview-canvas" class="w-full border border-gray-200 rounded"></canvas>
                <div class="mt-3 grid grid-cols-1 gap-3">
                    <label class="flex items-center justify-between text-sm">
                        <span>Saturation threshold</span>
                        <input id="ctl-sat" type="range" min="0" max="1" step="0.01" class="w-48" value="0.22">
                    </label>
                    <label class="flex items-center justify-between text-sm">
                        <span>Feather start</span>
                        <input id="ctl-feather-start" type="range" min="0.70" max="0.98" step="0.01" class="w-48" value="0.86">
                    </label>
                    <label class="flex items-center justify-between text-sm">
                        <span>Feather end</span>
                        <input id="ctl-feather-end" type="range" min="0.80" max="1.00" step="0.01" class="w-48" value="0.98">
                    </label>
                    <label class="flex items-center justify-between text-sm">
                        <span>Local window (px)</span>
                        <input id="ctl-window" type="range" min="3" max="35" step="2" class="w-48" value="17">
                    </label>
                    <label class="flex items-center justify-between text-sm">
                        <span>Keep blue ink boost</span>
                        <input id="ctl-blue" type="range" min="0" max="1" step="0.05" class="w-48" value="0.5">
                    </label>
                </div>
                <div class="mt-3 flex justify-end">
                    <button id="btn-update-preview" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-1 rounded border">Update Preview</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Signature Placement Options -->
        <div class="mb-8" id="placement-section" style="display: none;">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Step 3: Signature Placement</h2>
            
            <!-- Page Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Page</label>
                <select id="page-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="last">Last Page</option>
                    <option value="first">First Page</option>
                    <option value="all">All Pages</option>
                </select>
            </div>

            <!-- Position Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Signature Position</label>
                <div class="grid grid-cols-2 gap-2">
                    <button class="position-btn p-2 border border-gray-300 rounded-md hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" data-position="top-left">Top Left</button>
                    <button class="position-btn p-2 border border-gray-300 rounded-md hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" data-position="top-right">Top Right</button>
                    <button class="position-btn p-2 border border-gray-300 rounded-md hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" data-position="bottom-left">Bottom Left</button>
                    <button class="position-btn p-2 border border-gray-300 rounded-md hover:bg-blue-50 focus:ring-2 focus:ring-blue-500 bg-blue-500 text-white" data-position="bottom-right">Bottom Right</button>
                </div>
                <div class="mt-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="custom-position" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Use custom coordinates</span>
                    </label>
                    <div id="custom-coords" class="mt-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">X Position (px)</label>
                                <input type="number" id="custom-x" class="w-full p-1 text-sm border border-gray-300 rounded" placeholder="20">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Y Position (px)</label>
                                <input type="number" id="custom-y" class="w-full p-1 text-sm border border-gray-300 rounded" placeholder="20">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Size Controls -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Signature Size</label>
                <div class="space-y-3">
                    <div>
                        <label class="flex items-center justify-between text-sm">
                            <span>Width (px)</span>
                            <span id="width-value">100</span>
                        </label>
                        <input id="signature-width" type="range" min="50" max="300" value="100" class="w-full">
                    </div>
                    <div>
                        <label class="flex items-center justify-between text-sm">
                            <span>Height (px)</span>
                            <span id="height-value">Auto</span>
                        </label>
                        <input id="signature-height" type="range" min="20" max="200" value="0" class="w-full">
                        <label class="flex items-center mt-1">
                            <input type="checkbox" id="maintain-aspect" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                            <span class="ml-2 text-xs text-gray-700">Maintain aspect ratio</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <div class="border border-gray-300 rounded-md p-4 bg-gray-50">
                    <div id="preview-container" class="relative bg-white border border-gray-200 rounded" style="width: 300px; height: 200px; margin: 0 auto;">
                        <div id="signature-preview" class="absolute bg-blue-100 border-2 border-blue-300 rounded" style="width: 100px; height: 40px; bottom: 20px; right: 20px;">
                            <div class="text-xs text-blue-600 text-center leading-tight pt-2">Signature</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 text-center mt-2">Preview of signature placement</div>
                </div>
            </div>
        </div>

        <!-- Step 4: Add Signature Button -->
        <button id="add-signature-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
            Add Signature & Download
        </button>

        <!-- Message Area -->
        <p id="status" class="text-center text-gray-600 mt-4 h-5"></p>

    </div>

    <script>
        const { PDFDocument } = PDFLib;

        const pdfUpload = document.getElementById('pdf-upload');
        const imgUpload = document.getElementById('img-upload');
        const addSignatureBtn = document.getElementById('add-signature-btn');
        const pdfNameEl = document.getElementById('pdf-name');
        const imgNameEl = document.getElementById('img-name');
        const statusEl = document.getElementById('status');
        
        let pdfFile = null;
        let imgFile = null;
        let selectedPosition = 'bottom-right';
        let selectedPage = 'last';
        let customPosition = { x: 20, y: 20 };
        let signatureSize = { width: 100, height: 0 }; // height 0 means auto
        let maintainAspectRatio = true;

        function updateButtonState() {
             addSignatureBtn.disabled = !(pdfFile && imgFile);
        }

        pdfUpload.addEventListener('change', (e) => {
            pdfFile = e.target.files[0];
            if (pdfFile) {
                pdfNameEl.textContent = `Selected: ${pdfFile.name}`;
            } else {
                 pdfNameEl.textContent = '';
            }
            updateButtonState();
        });

        imgUpload.addEventListener('change', (e) => {
            imgFile = e.target.files[0];
            if (imgFile) {
                imgNameEl.textContent = `Selected: ${imgFile.name}`;
                // Show placement section when both files are selected
                document.getElementById('placement-section').style.display = 'block';
                // Update preview with actual image dimensions
                updateHeightFromAspectRatio();
                updatePreview();
            } else {
                imgNameEl.textContent = '';
                document.getElementById('placement-section').style.display = 'none';
            }
            updateButtonState();
        });
        
        async function removeWhiteBackground(imageFile, paramsOverride) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // Parameters with sensible defaults; can be overridden by preview controls
                        const params = Object.assign({
                            saturationThreshold: 0.22,
                            featherStart: 0.86,
                            featherEnd: 0.98,
                            windowRadius: 17,
                            blueBoost: 0.5
                        }, paramsOverride || {});

                        function computeLuminance(r, g, b) {
                            return (0.2126 * (r / 255)) + (0.7152 * (g / 255)) + (0.0722 * (b / 255));
                        }
                        function rgbToHsv(r, g, b) {
                            const rn = r / 255, gn = g / 255, bn = b / 255;
                            const max = Math.max(rn, gn, bn), min = Math.min(rn, gn, bn);
                            const d = max - min;
                            let h = 0;
                            if (d !== 0) {
                                switch (max) {
                                    case rn: h = ((gn - bn) / d + (gn < bn ? 6 : 0)); break;
                                    case gn: h = ((bn - rn) / d + 2); break;
                                    case bn: h = ((rn - gn) / d + 4); break;
                                }
                                h /= 6;
                            }
                            const s = max === 0 ? 0 : d / max;
                            return { h, s, v: max };
                        }
                        function smoothstep(edge0, edge1, x) {
                            const t = Math.min(1, Math.max(0, (x - edge0) / (edge1 - edge0)));
                            return t * t * (3 - 2 * t);
                        }

                        // Build integral image of luminance for fast local mean
                        const w = canvas.width, h = canvas.height;
                        const integral = new Float32Array((w + 1) * (h + 1));
                        function idx(x, y) { return y * (w + 1) + x; }
                        for (let y = 1; y <= h; y++) {
                            let rowSum = 0;
                            for (let x = 1; x <= w; x++) {
                                const di = ((y - 1) * w + (x - 1)) * 4;
                                const lum = computeLuminance(data[di], data[di + 1], data[di + 2]);
                                rowSum += lum;
                                integral[idx(x, y)] = integral[idx(x, y - 1)] + rowSum;
                            }
                        }
                        function getMeanLum(x, y, r) {
                            const x0 = Math.max(1, x - r), y0 = Math.max(1, y - r);
                            const x1 = Math.min(w, x + r), y1 = Math.min(h, y + r);
                            const A = integral[idx(x0 - 1, y0 - 1)];
                            const B = integral[idx(x1, y0 - 1)];
                            const C = integral[idx(x0 - 1, y1)];
                            const D = integral[idx(x1, y1)];
                            const area = (x1 - x0 + 1) * (y1 - y0 + 1);
                            return (D - B - C + A) / area;
                        }

                        // Process pixels using local mean, saturation and hue bias for blue ink
                        for (let y = 0; y < h; y++) {
                            for (let x = 0; x < w; x++) {
                                const i = (y * w + x) * 4;
                                const r = data[i], g = data[i + 1], b = data[i + 2];
                                const a = data[i + 3];
                                const hsv = rgbToHsv(r, g, b);
                                const lum = computeLuminance(r, g, b);
                                const meanLum = getMeanLum(x + 1, y + 1, params.windowRadius);

                                // How white-like compared to local background
                                const whiteness = Math.max(0, lum - meanLum + 0.08); // small bias helps textured paper
                                let t = smoothstep(params.featherStart, params.featherEnd, Math.min(1, meanLum + whiteness));

                                // Reduce transparency if pixel seems like blue ink
                                const blueHue = hsv.h; // 0..1
                                const isBlue = (blueHue > 0.55 && blueHue < 0.75) && hsv.s > 0.25;
                                if (isBlue) {
                                    t *= (1 - params.blueBoost);
                                }

                                // Also keep colored/ink pixels with higher saturation
                                if (hsv.s > params.saturationThreshold) {
                                    t *= 0.3;
                                }

                                const newAlpha = Math.round(a * (1 - t));
                                data[i + 3] = newAlpha;
                            }
                        }

                        ctx.putImageData(imageData, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(imageFile);
            });
        }

        function dataURLToUint8Array(dataURL) {
            const base64 = dataURL.split(',')[1];
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }

        // Live preview handling
        const previewSection = document.getElementById('preview-section');
        const previewCanvas = document.getElementById('preview-canvas');
        const btnUpdatePreview = document.getElementById('btn-update-preview');
        const ctlSat = document.getElementById('ctl-sat');
        const ctlFeatherStart = document.getElementById('ctl-feather-start');
        const ctlFeatherEnd = document.getElementById('ctl-feather-end');
        const ctlWindow = document.getElementById('ctl-window');
        const ctlBlue = document.getElementById('ctl-blue');

        function currentParams() {
            return {
                saturationThreshold: parseFloat(ctlSat.value),
                featherStart: parseFloat(ctlFeatherStart.value),
                featherEnd: parseFloat(ctlFeatherEnd.value),
                windowRadius: parseInt(ctlWindow.value, 10),
                blueBoost: parseFloat(ctlBlue.value)
            };
        }

        async function renderPreview() {
            if (!imgFile) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = async function() {
                    // Fit preview width to container while keeping aspect
                    const maxW = 480;
                    const scale = Math.min(1, maxW / img.width);
                    previewCanvas.width = Math.round(img.width * scale);
                    previewCanvas.height = Math.round(img.height * scale);
                    const ctx = previewCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, previewCanvas.width, previewCanvas.height);

                    // Process using same algorithm on scaled canvas
                    const temp = document.createElement('canvas');
                    temp.width = previewCanvas.width;
                    temp.height = previewCanvas.height;
                    const tctx = temp.getContext('2d');
                    tctx.drawImage(previewCanvas, 0, 0);
                    const imageData = tctx.getImageData(0, 0, temp.width, temp.height);

                    // Reuse removal core by serializing to blob and back through removeWhiteBackground
                    temp.toBlob(async (blob) => {
                        const processed = await removeWhiteBackground(new File([blob], 'prev.png', { type: 'image/png' }), currentParams());
                        const previewImg = new Image();
                        previewImg.onload = function() {
                            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                            ctx.drawImage(previewImg, 0, 0, previewCanvas.width, previewCanvas.height);
                        };
                        previewImg.src = processed;
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(imgFile);
        }

        document.getElementById('remove-bg-check').addEventListener('change', (e) => {
            previewSection.classList.toggle('hidden', !e.target.checked);
            if (e.target.checked) {
                renderPreview();
            }
        });
        btnUpdatePreview.addEventListener('click', () => {
            renderPreview();
        });

        // Placement control event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Position buttons
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                    this.classList.add('bg-blue-500', 'text-white');
                    selectedPosition = this.dataset.position;
                    updatePreview();
                });
            });

            // Page selection
            document.getElementById('page-select').addEventListener('change', function() {
                selectedPage = this.value;
            });

            // Custom position checkbox
            document.getElementById('custom-position').addEventListener('change', function() {
                const customCoords = document.getElementById('custom-coords');
                if (this.checked) {
                    customCoords.classList.remove('hidden');
                } else {
                    customCoords.classList.add('hidden');
                }
            });

            // Custom coordinates
            document.getElementById('custom-x').addEventListener('input', function() {
                customPosition.x = parseInt(this.value) || 20;
                updatePreview();
            });

            document.getElementById('custom-y').addEventListener('input', function() {
                customPosition.y = parseInt(this.value) || 20;
                updatePreview();
            });

            // Size controls
            document.getElementById('signature-width').addEventListener('input', function() {
                signatureSize.width = parseInt(this.value);
                document.getElementById('width-value').textContent = signatureSize.width;
                if (maintainAspectRatio && imgFile) {
                    updateHeightFromAspectRatio();
                }
                updatePreview();
            });

            document.getElementById('signature-height').addEventListener('input', function() {
                signatureSize.height = parseInt(this.value);
                document.getElementById('height-value').textContent = signatureSize.height;
                updatePreview();
            });

            // Maintain aspect ratio checkbox
            document.getElementById('maintain-aspect').addEventListener('change', function() {
                maintainAspectRatio = this.checked;
                if (maintainAspectRatio && imgFile) {
                    updateHeightFromAspectRatio();
                    updatePreview();
                }
            });
        });

        function updateHeightFromAspectRatio() {
            if (!imgFile) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const aspectRatio = img.height / img.width;
                    const newHeight = Math.round(signatureSize.width * aspectRatio);
                    signatureSize.height = newHeight;
                    document.getElementById('signature-height').value = newHeight;
                    document.getElementById('height-value').textContent = newHeight;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(imgFile);
        }

        function updatePreview() {
            const preview = document.getElementById('signature-preview');
            const container = document.getElementById('preview-container');
            const containerRect = container.getBoundingClientRect();
            
            // Calculate position based on selection
            let x, y;
            const padding = 20;
            
            if (document.getElementById('custom-position').checked) {
                x = customPosition.x;
                y = customPosition.y;
            } else {
                switch (selectedPosition) {
                    case 'top-left':
                        x = padding;
                        y = padding;
                        break;
                    case 'top-right':
                        x = 300 - signatureSize.width - padding;
                        y = padding;
                        break;
                    case 'bottom-left':
                        x = padding;
                        y = 200 - signatureSize.height - padding;
                        break;
                    case 'bottom-right':
                    default:
                        x = 300 - signatureSize.width - padding;
                        y = 200 - signatureSize.height - padding;
                        break;
                }
            }
            
            // Update preview position and size
            preview.style.left = x + 'px';
            preview.style.top = y + 'px';
            preview.style.width = signatureSize.width + 'px';
            preview.style.height = signatureSize.height + 'px';
        }


        addSignatureBtn.addEventListener('click', async () => {
            if (!pdfFile || !imgFile) {
                statusEl.textContent = 'Please select both a PDF and an image.';
                return;
            }

            statusEl.textContent = 'Processing...';
            addSignatureBtn.disabled = true;

            try {
                const pdfBytes = await pdfFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                
                let imgBytes;
                let isPng = imgFile.type === 'image/png';
                const removeBgCheckbox = document.getElementById('remove-bg-check');

                if (removeBgCheckbox.checked) {
                    statusEl.textContent = 'Removing background...';
                    const processedImageDataURL = await removeWhiteBackground(imgFile, currentParams());
                    const bytes = dataURLToUint8Array(processedImageDataURL);
                    imgBytes = bytes; // Uint8Array
                    isPng = true; // Output is always PNG to support transparency
                } else {
                    // If original is PNG/JPG, read as Uint8Array for consistency
                    const buf = await imgFile.arrayBuffer();
                    imgBytes = new Uint8Array(buf);
                }

                statusEl.textContent = 'Embedding signature...';
                
                let signatureImage;
                if (isPng) {
                    signatureImage = await pdfDoc.embedPng(imgBytes);
                } else {
                    signatureImage = await pdfDoc.embedJpg(imgBytes);
                }
                
                // Calculate signature dimensions
                let signatureWidth = signatureSize.width;
                let signatureHeight = signatureSize.height;
                
                // If height is 0 or aspect ratio is maintained, calculate from width
                if (signatureHeight === 0 || maintainAspectRatio) {
                    const aspectRatio = signatureImage.height / signatureImage.width;
                    signatureHeight = Math.round(signatureWidth * aspectRatio);
                }
                
                const signatureDims = signatureImage.scale(signatureWidth / signatureImage.width);

                const pages = pdfDoc.getPages();
                const pagesToSign = [];
                
                // Determine which pages to sign
                switch (selectedPage) {
                    case 'first':
                        pagesToSign.push(pages[0]);
                        break;
                    case 'last':
                        pagesToSign.push(pages[pages.length - 1]);
                        break;
                    case 'all':
                        pagesToSign.push(...pages);
                        break;
                }

                // Add signature to selected pages
                for (const page of pagesToSign) {
                    const { width, height } = page.getSize();
                    
                    // Calculate position based on selection
                    let x, y;
                    const padding = 20;
                    
                    if (document.getElementById('custom-position').checked) {
                        x = customPosition.x;
                        y = customPosition.y;
                    } else {
                        switch (selectedPosition) {
                            case 'top-left':
                                x = padding;
                                y = height - signatureDims.height - padding;
                                break;
                            case 'top-right':
                                x = width - signatureDims.width - padding;
                                y = height - signatureDims.height - padding;
                                break;
                            case 'bottom-left':
                                x = padding;
                                y = padding;
                                break;
                            case 'bottom-right':
                            default:
                                x = width - signatureDims.width - padding;
                                y = padding;
                                break;
                        }
                    }
                    
                    page.drawImage(signatureImage, {
                        x: x,
                        y: y,
                        width: signatureDims.width,
                        height: signatureDims.height,
                    });
                }

                const pdfBytesSigned = await pdfDoc.save();

                const blob = new Blob([pdfBytesSigned], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const originalName = pdfFile.name.replace(/\.pdf$/i, '');
                link.download = `${originalName}-signed.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                statusEl.textContent = 'Download complete!';

            } catch (error) {
                console.error(error);
                statusEl.textContent = 'An error occurred. Please check the console.';
            } finally {
                updateButtonState();
            }
        });
        
        updateButtonState();
        
        // Initialize preview on page load
        updatePreview();
    </script>
</body>
</html>

